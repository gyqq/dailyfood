<style lang="less">
  page{
    background-color: #f0eff5;
  }
  .groupState .groupState-one{
    height: 120rpx;
    line-height: 120rpx;
    text-align: center;
    color: #8A3918;
    font-size: 32rpx;
    width: 100%;
    margin-top: 10rpx;
    background-color: white;
    font-weight: bolder;
    letter-spacing: 3rpx;
  }
  .groupState .left{
    display: block;
    float: left;
  }.groupState .right{
     display: block;
     float: right;
   }
  /*商品*/
  .groupState .confirmOrder-productIfo{
    background-color: white;
    margin-top: 10rpx;
  }
  .groupState .confirmOrder-productIfo .pro-item{
    height: 180rpx;
    overflow: hidden;
  }
  .groupState .confirmOrder-productIfo .pro-item .pro-img{
    width: 112rpx;
    height: 120rpx;
    background-color: #eeeeee;
    margin-left:30rpx;
    margin-top: 30rpx;
  }
  .groupState .confirmOrder-productIfo .pro-item .pro-ifo{
    width: 450rpx;
    margin-left:30rpx;
    height: 150rpx;
    margin-top: 30rpx;
    overflow: hidden;
  }
  .groupState .confirmOrder-productIfo .pro-item .pro-ifo .pro-title{
    font-size: 24rpx;
    color: #3F2021;

  }
  .groupState .confirmOrder-productIfo .pro-item .pro-ifo .pro-num{
    font-size: 20rpx;
    color: #3F2021;
  }
  .groupState .confirmOrder-productIfo .pro-item .pro-ifo .pro-groupPrice{
    font-size: 28rpx;
    color: #3F2021;
    margin-left: 10rpx;
  }
  .groupState .confirmOrder-productIfo .pro-item .pro-ifo .pro-originalPrice{
    font-size: 24rpx;
    color: #959595;
    margin-left: 70rpx;
    text-decoration:line-through
  }
  /*团购人员*/
  .groupState .groupState-three{
    /*height: 498rpx;*/
    padding-bottom: 20rpx;
    margin-top: 10rpx;
    background-color: white;
    /*line-height: 498rpx;*/
  }
  .groupState .groupState-three .three-text{
    font-size: 28rpx;
    margin: 0 auto;
    margin-top: 0rpx;
    text-align: center;
    width: 90%;
  }
  .groupState .groupState-three .three-text view{
    margin-top: 20rpx;
  }
  .groupState .groupState-three .three-text view text{
    margin: 0 auto;
    width: 97%;
    height: 80rpx;
    margin-top: 20rpx;
    line-height: 60rpx;
    display: inline;
  }
  .groupState .groupState-three .three-text view text .three-time{
    color: #b58150;

  }
  /*头像*/
  .groupState .groupState-three .three-people{
    /*width: 90%;*/
    text-align: center;
    margin: 0 auto;
    margin-top: 30rpx;
    overflow: auto;
  }
  .groupState .groupState-three .three-people .pro-img{
    width: 120rpx;
    height: 120rpx;
    border-radius: 50%;
    background-color: #eeeeee;
    margin-left:30rpx;
    display: inline-block;
  }
  .groupState .groupState-three .three-people .pro-img:nth-child(1){
    margin-left: 0;
  }
  .groupState .groupState-three .three-operation{
    margin-top: 40rpx;
  }
  /*邀请好友*/
  .groupState .groupState-three .three-operation .invitationBtn{
    width: 460rpx;
    height: 76rpx;
    line-height: 76rpx;
    font-size: 27rpx;
    color: #fffefe;
    background-color: #3e2020;
  }
  .groupState .groupState-three .three-operation .failure{
    display: block;
    float: left;
    background-color: #959595;
    width: 215rpx;
    height: 76rpx;
    line-height: 76rpx;
    font-size: 27rpx;
    border-radius: 4rpx;
    color: white;
    margin-left: 145rpx;
  }
  .groupState .groupState-three .three-operation .failure:nth-child(2){
    margin-left: 30rpx;
  }
  /*客服*/
  .groupState .groupState-four{
    margin-top: 10rpx;
    background-color: white;
    height: 88rpx;
    width: 100%;
  }
  .groupState .groupState-four .customerService{
    height: 64rpx;
    margin: 0 auto;
    margin-top: 13rpx;
    width: 330rpx;
    border: 1rpx solid #999999;
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAABLUExURUxpcbWAT7WBT7WEUrWBT7WBT7aBT7WBT7WBT7WAT7SBT7WBT7WAULWBT7WAT7WAULSMULWAT7SBT7SBULWAULWAT7WBULWBT7WBUEkqmKQAAAAYdFJOUwAyxhNX6SJipztvu0mC8+AH/dp7noyz0g/0nuoAAAElSURBVDjLfVMJkoQgDOSQW0U8xv7/SxfE0QFxU1YRTNOkk0DIbXJxAhjdQEnLqAMQvB/jsvfP+AAwJZPHuwhd6/gH4ucUZdh5EXfQU/Fjg5iKrX5e6e6Nwf5MSsNevgBvyAq4CXRLt70oPpDNymD8OqIZj1nkgxRbG9BBHWuPvg2QZxKxJmsjCb7NuRQrkj1IZGosGCEKTk4dwlQBPOzE19i0MWTNqoyb3E8BAp+VDLWCLislmPOBpSlRfxn+A5wMwytAvORwABjiZ45+mbqKiZnHflFgUZ9UkdKWOMN2TFr6EAvp6jrFDiWzecztxc8ppTwThF4p2Xgc0QZiGARtDoDQqx4xo34Fp+04p9WZ9oSwY8b4U9JP5t57wLwBiIq3Yy46/wf91BI5Ki9rWAAAAABJRU5ErkJggg==");
    background-repeat: no-repeat;
    background-size:33rpx ;
    text-align: center;
    line-height: 64rpx;
    text-indent:50rpx;
    font-size: 24rpx;
    letter-spacing: 5rpx;
    background-position:26%
  }
</style>
<template>
  <view class="groupState">
    <view class="groupState-one">{{groupTitle}}</view>
    <view class="confirmOrder-productIfo">
      <view class="pro-item">
        <image src="{{orderDetail.groupon_image}}" class="pro-img left"></image>
        <view class="pro-ifo left">
          <text class="pro-title">{{orderDetail.groupon_name}}</text>
          <view class="pro-price">
            <text class="pro-num">{{orderDetail.person}}人拼团价</text>
            <text class="pro-groupPrice">￥{{orderDetail.groupon_price}}</text>
            <text class="pro-originalPrice">￥{{orderDetail.origin_price}}</text>
          </view>
        </view>
      </view>
    </view>
    <view class="groupState-three">
      <view class="three-text">
        <view>
          <text wx:if="{{orderDetail.textType=='开团成功' || orderDetail.textType=='蹭团成功'}}">拼团还未成功，邀请好友一起来日尝食食团购美食哦!还差{{groupIng.cunt}}人,<text class="three-time"> {{countdown}}</text>后结束!</text>
        </view>
        <text wx:if="{{orderDetail.textType!='开团成功' && orderDetail.textType!='蹭团成功'}}">{{textIfn}}</text>
      </view>
      <view class="three-people">
        <image wx:for="{{groupPerson}}" wx:for-index="index" wx:for-item="item" wx:key="id" src="{{item.member_img}}" class=" pro-img "></image>
      </view>
      <view class="three-operation">
        <button wx:if="{{orderDetail.inviteBtn}}"  open-type="share" class="invitationBtn">立即邀请好友</button>
        <button wx:if="{{orderDetail.otherBtn}}" @tap="buyOtherGoods" style="background: white;border:1rpx solid #3e2020;color:#3e2020" class="invitationBtn">团购其它商品</button>
        <button wx:if="{{orderDetail.rubBtn}}"  class="failure">去蹭团</button>
        <button wx:if="{{orderDetail.startBtn}}"  class="failure">立即开团</button>
      </view>
    </view>
    <view class="groupState-four">
      <view class="customerService" @tap="callService">
        联系客服
      </view>
    </view>
  </view>
</template>

<script>
  import wepy from 'wepy';
  import { connect } from 'wepy-redux';
  import util from '@/mixins/util'

  export default class groupState extends wepy.page {
    config = {
      navigationBarTitleText: ''
    };
    components = {};

    //mixins = [testMixin];

    data = {
      globalData:wepy.$instance.globalData,
      currentTime:0,//时间戳刷新
      countdown:'',//时分秒
      groupOn_id:'',//订单号
      groupTitle:'',//标题
      textIfn:'',//图片上面标题
      groupIng:{//开团成功   蹭团成功
        cunt:null,//相差人数
      },
      orderDetail:{},
      groupPerson:[],//头像
    };

    computed = {};

    methods = {
      callService(){//联系客服
        wx.navigateTo({
          url: './../../webView/webView?url=' + 'https://shinhocloud.kf5.com/kchat/?lang=zh_CN&active_in_iframe=1#/chatbox'
        })
      },
      buyOtherGoods(){//团购其它商品
        wx.reLaunch({
          url: '../groupBuying'
        })
      }
    };

    events = {};
    getGroupState(){
      wepy.showLoading({
        title: '加载中',
      })
      var self =this
      var publicStr = wepy.$instance.getPublicData()
      let url = self.globalData.base_url+self.globalData.version_no+'/group-buy/'+this.groupOn_id+publicStr
      console.log(url)
      wepy.request({
        url:url,
        method: "get",
        header: {
          "Content-Type": "application/json; charset=UTF-8",  //post
        },
        success: function(res) {
          if (!res.data.results[0]) {
            return false
          }
          var data = res.data.results[0]
          //图片
          data.groupAct.buyers.map((item) =>{
            item.member_img = self.globalData.base_url+self.globalData.version_no+'/img/'+item.member_img
          })
          data.groupon_image = self.globalData.base_url+self.globalData.version_no+'/img/'+data.groupon_image
          var member_id = wx.getStorageSync('memberId')
          var  create_time= parseInt(data.groupAct.create_time)
          var  remain_time = parseInt(data.remain_time)
          var currentInterval = parseInt(Date.parse(new Date()))/1000;//获取当前时间戳
         //头部逻辑
          if (data.groupAct.status=='3'){//团购成功
            data.textType = '团购成功'
            self.groupTitle = '恭喜您,团购成功!'

          }else {// 开团成功,蹭团成功,团购失败

            if (create_time+remain_time>currentInterval) {
              if (data.groupAct.owner_id==member_id) {
                data.textType = '开团成功'
                self.groupTitle = '恭喜您, 开团成功!'

              }else {
                data.textType = '蹭团成功'
                self.groupTitle = '恭喜您, 蹭团成功!'
              }
            }else {
              data.textType = '团购失败'
              self.groupTitle = '很遗憾, 团购失败!'
            }
          }
          wepy.setNavigationBarTitle({
            title: data.textType
          })

          //头像显示
          self.groupPerson= data.groupAct.buyers
            //缺少人数
          self.groupIng.cunt = parseInt(data.person) - parseInt(data.groupAct.join_num)
          if (self.groupPerson.length < parseInt(data.person)){//实际人数少于  总人数
            for (var i=0;i<self.groupIng.cunt;i++) {
              var per = {
                member_img:''
              }
              self.groupPerson.push(per)
            }
          }
          //中间部文字  和按钮逻辑
          if (data.groupAct.status=='3') {
            data.otherBtn = true;//团购其它
            data.inviteBtn = false;//邀请好友
            data.rubBtn = false;//蹭团
            data.startBtn = false;//立即开团
            self.textIfn = '拼团已满'+data.person+'人,团购成功!'
          }else {
            if (create_time+remain_time>currentInterval) {
              var person = parseInt(data.person)
              var join_num = parseInt(data.groupAct.join_num)
              var pay_num = parseInt(data.groupAct.pay_num)
              if (person==join_num && pay_num < person) {
                data.otherBtn = true;//团购其它
                data.inviteBtn = false;//邀请好友
              }else {
                data.otherBtn = false;//团购其它
                data.inviteBtn = true;//邀请好友
              }
              data.rubBtn = false;//蹭团
              data.startBtn = false;//立即开团

              self.currentTime = create_time+remain_time-currentInterval
              var currentTime = self.currentTime
              console.log(self.cuntTime)
              var intervalTime = setInterval(function () {
                //console.log(currentTime)
                currentTime--;
                if (currentTime <= 0) {
                  self.currentTime =0
                  clearInterval(intervalTime)
                  self.textIfn = '拼团还未成功，邀请好友一起来日尝食食团购美食哦!还差'+cunt+'人,00:00:00后结束!'
                }
                self.countdown = util.formatDuring(currentTime*1000)
                //console.log(self.countdown)

                //self.textIfn = '拼团还未成功，邀请好友一起来日尝食食团购美食哦!还差'+cunt+'人,'+time+'后结束!'
                self.$apply();
              }, 1000)

            }else {
              self.textIfn = '拼团未满'+data.person+'人,团购失败!'
            }

          }
          self.orderDetail = data
          wepy.hideLoading()
          self.$apply()
          console.log(data)
        }
      })
    }

    onLoad(options) {
      console.log(options)
      //蹭团成功  开团成功   团购成功   团购失败 "180910092967735"
      this.groupOn_id = options.groupOn_id
      //this.groupOn_id = '180910092967735'
      this.getGroupState()
    }
    onShareAppMessage(res){
      var res = this.orderDetail
      console.log(res)
      console.log('groupOn_id='+res.groupon_id)
      console.log('groupon_image='+res.groupon_image)
      console.log('gactivityId='+res.groupAct.gactivity_id)
      return {
        title: '邀请团购',
        path: 'pages/groupBuying/groupDetails/groupDetails?groupType=join&groupon_id='+res.groupon_id+'&gactivityId='+res.groupAct.gactivity_id,
        imageUrl:res.groupon_image
      }
    }
  }
</script>
