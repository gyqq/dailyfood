<style lang="less">
  page{
    background-color: #f0eff5;
  }
  .groupState .groupState-one{
    height: 120rpx;
    line-height: 120rpx;
    text-align: center;
    color: #8A3918;
    font-size: 32rpx;
    width: 100%;
    margin-top: 10rpx;
    background-color: white;
    font-weight: bolder;
    letter-spacing: 3rpx;
  }
  .groupState .left{
    display: block;
    float: left;
  }.groupState .right{
     display: block;
     float: right;
   }
  /*商品*/
  .groupState .confirmOrder-productIfo{
    background-color: white;
    margin-top: 10rpx;
  }
  .groupState .confirmOrder-productIfo .pro-item{
    height: 180rpx;
    overflow: hidden;
  }
  .groupState .confirmOrder-productIfo .pro-item .pro-img{
    width: 112rpx;
    height: 120rpx;
    background-color: #eeeeee;
    margin-left:30rpx;
    margin-top: 30rpx;
  }
  .groupState .confirmOrder-productIfo .pro-item .pro-ifo{
    width: 450rpx;
    margin-left:30rpx;
    height: 150rpx;
    margin-top: 30rpx;
    overflow: hidden;
  }
  .groupState .confirmOrder-productIfo .pro-item .pro-ifo .pro-title{
    font-size: 24rpx;
    color: #3F2021;

  }
  .groupState .confirmOrder-productIfo .pro-item .pro-ifo .pro-num{
    font-size: 20rpx;
    color: #3F2021;
  }
  .groupState .confirmOrder-productIfo .pro-item .pro-ifo .pro-groupPrice{
    font-size: 28rpx;
    color: #3F2021;
    margin-left: 10rpx;
  }
  .groupState .confirmOrder-productIfo .pro-item .pro-ifo .pro-originalPrice{
    font-size: 24rpx;
    color: #959595;
    margin-left: 70rpx;
    text-decoration:line-through
  }
  /*团购人员*/
  .groupState .groupState-three{
    /*height: 498rpx;*/
    padding-bottom: 20rpx;
    margin-top: 10rpx;
    background-color: white;
    /*line-height: 498rpx;*/
  }
  .groupState .groupState-three .three-text{
    font-size: 28rpx;
    margin: 0 auto;
    margin-top: 0rpx;
    text-align: center;
    width: 90%;
  }
  .groupState .groupState-three .three-text .three-title{
    margin-bottom: 0rpx;
    height: 60rpx;
    line-height: 60rpx;
  }
  .groupState .groupState-three .three-text .three-title .three-time{
    color: #b58150;
  }
  /*头像*/
  .groupState .groupState-three .three-people{
    /*width: 90%;*/
    text-align: center;
    margin: 0 auto;
    margin-top: 30rpx;
    overflow: auto;
  }
  .groupState .groupState-three .three-people .pro-img{
    width: 120rpx;
    height: 120rpx;
    border-radius: 50%;
    background-color: #eeeeee;
    margin-left:30rpx;
    display: inline-block;
  }
  .groupState .groupState-three .three-people .pro-img:nth-child(1){
    margin-left: 0;
  }
  .groupState .groupState-three .three-operation{
    margin-top: 40rpx;
  }
  /*邀请好友*/
  .groupState .groupState-three .three-operation .invitationBtn{
    width: 460rpx;
    height: 76rpx;
    line-height: 76rpx;
    font-size: 27rpx;
    color: #fffefe;
    background-color: #3e2020;
  }
  .groupState .groupState-three .three-operation .failure{
    display: block;
    float: left;
    background-color: #959595;
    width: 215rpx;
    height: 76rpx;
    line-height: 76rpx;
    font-size: 27rpx;
    border-radius: 4rpx;
    color: white;
    margin-left: 145rpx;
  }
  .groupState .groupState-three .three-operation .failure:nth-child(2){
    margin-left: 30rpx;
  }
  /*客服*/
  .groupState .groupState-four{
    margin-top: 10rpx;
    background-color: white;
    height: 88rpx;
    width: 100%;
  }
  .groupState .groupState-four .customerService{
    height: 64rpx;
    margin: 0 auto;
    margin-top: 13rpx;
    width: 330rpx;
    border: 1rpx solid #999999;
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAABLUExURUxpcbWAT7WBT7WEUrWBT7WBT7aBT7WBT7WBT7WAT7SBT7WBT7WAULWBT7WAT7WAULSMULWAT7SBT7SBULWAULWAT7WBULWBT7WBUEkqmKQAAAAYdFJOUwAyxhNX6SJipztvu0mC8+AH/dp7noyz0g/0nuoAAAElSURBVDjLfVMJkoQgDOSQW0U8xv7/SxfE0QFxU1YRTNOkk0DIbXJxAhjdQEnLqAMQvB/jsvfP+AAwJZPHuwhd6/gH4ucUZdh5EXfQU/Fjg5iKrX5e6e6Nwf5MSsNevgBvyAq4CXRLt70oPpDNymD8OqIZj1nkgxRbG9BBHWuPvg2QZxKxJmsjCb7NuRQrkj1IZGosGCEKTk4dwlQBPOzE19i0MWTNqoyb3E8BAp+VDLWCLislmPOBpSlRfxn+A5wMwytAvORwABjiZ45+mbqKiZnHflFgUZ9UkdKWOMN2TFr6EAvp6jrFDiWzecztxc8ppTwThF4p2Xgc0QZiGARtDoDQqx4xo34Fp+04p9WZ9oSwY8b4U9JP5t57wLwBiIq3Yy46/wf91BI5Ki9rWAAAAABJRU5ErkJggg==");
    background-repeat: no-repeat;
    background-size:33rpx ;
    text-align: center;
    line-height: 64rpx;
    text-indent:50rpx;
    font-size: 24rpx;
    letter-spacing: 5rpx;
    background-position:26%
  }
</style>
<template>
  <view class="groupState">
    <view class="groupState-one">{{groupTitle}}</view>
    <view class="confirmOrder-productIfo">
      <view class="pro-item">
        <image src="https://ec-api.shinho.net.cn/v1/img/" class="pro-img left"></image>
        <view class="pro-ifo left">
          <text class="pro-title">刘叔加的油桃</text>
          <view class="pro-price">
            <text class="pro-num">2人拼团价</text>
            <text class="pro-groupPrice">￥36</text>
            <text class="pro-originalPrice">￥42</text>
          </view>
        </view>
      </view>
    </view>
    <view class="groupState-three">
      <view class="three-text">
        <text class="three-title" wx:if="{{groupState=='蹭团成功' ||groupState=='开团成功'}}">
          拼团还未成功,邀请好友一起来日常食食团购没事哦!
          还差1人, <text class="three-time">07:36:24</text>后结束
        </text>
        <text class="three-title" style="margin-top: 40rpx;display: block;" wx:if="{{groupState=='团购成功' ||groupState=='团购失败'}}">拼团已满3人,团购成功!</text>
      </view>
      <view class="three-people">
        <image src="https://ec-api.shinho.net.cn/v1/img/" class=" pro-img "></image>
        <image src="https://ec-api.shinho.net.cn/v1/img/" class=" pro-img "></image>
        <image src="https://ec-api.shinho.net.cn/v1/img/" class=" pro-img "></image>
      </view>
      <view class="three-operation">
        <button wx:if="{{groupState=='蹭团成功' ||groupState=='开团成功'}}" class="invitationBtn">立即邀请好友</button>
        <button wx:if="{{groupState=='团购成功'}}" style="background: white;border:1rpx solid #3e2020;color:#3e2020" class="invitationBtn">团购其它商品</button>
        <button wx:if="{{groupState=='团购失败'}}"  class="failure">去蹭团</button>
        <button wx:if="{{groupState=='团购失败'}}"  class="failure">立即开团</button>
      </view>
    </view>
    <view class="groupState-four">
      <view class="customerService" @tap="callService">
        联系客服
      </view>
    </view>
  </view>
</template>

<script>
  import wepy from 'wepy';
  import { connect } from 'wepy-redux';

  export default class groupState extends wepy.page {
    config = {
      navigationBarTitleText: '蹭团成功'
    };
    components = {};

    //mixins = [testMixin];

    data = {
      globalData:wepy.$instance.globalData,
      order_id:'',//订单号
      groupTitle:'',//标题
      groupState:'',
      orderDetail:{},
    };

    computed = {};

    methods = {
      callService(){//联系客服
        wx.navigateTo({
          url: './../../webView/webView?url=' + 'https://shinhocloud.kf5.com/kchat/?lang=zh_CN&active_in_iframe=1#/chatbox'
        })
      },
    };

    events = {};
    getOrderDetail(){
      //delivering //待收货
      // finish//已完成
      // cancel//已取消
      // dead //已作废
      // "active";//组团成功
      // "pendding";//进行中
      var self =this
      var publicStr = wepy.$instance.getPublicData()
      let url = self.globalData.base_url+self.globalData.version_no+'/group-buy/order/'+this.order_id+publicStr
      console.log(url)
      wepy.request({
        url:url,
        method: "get",
        header: {
          "Content-Type": "application/json; charset=UTF-8",  //post
        },
        success: function(res) {
          //console.log(res)
          var data = res.data.results[0]
          //图片
          if (data.groups) {
            data.groups.groupon_image = self.globalData.base_url+self.globalData.version_no+'/img/'+data.groups.groupon_image
          }

          if (data.status=='finish' || data.status=='uncommented') {//已完成
            data.typeText = '已完成'
          }
          if (data.status=='cancel' ||data.status=='dead') {//已取消
            data.typeText = '已取消'
          }
          //当status为active时用来区分待发货,待收货，然后为pedding时判断待付款,待成团、已过期
          //小分类  进行中:(待付款,待成团,待发货,待收货)
          if (data.status=='pendding' || data.status=='active') {//进行中
            //组团成功
            if (data.status=='active') {//分为 待收货  待发货
              if (data.ship_status=='0') {//待发货
                data.typeText = '待发货'
              }else if (data.ship_status=='1') {//待收货
                data.typeText = '待收货'
              }
            }else {//组团不成功  (未支付,已过期,待成团)  pendding
              var  create_time= parseInt(data.groups.create_time)
              var  remain_time = parseInt(data.groups.remain_time)
              var currentInterval = parseInt(Date.parse(new Date()))/1000;//获取当前时间戳
              var all = create_time+remain_time

              if (create_time+remain_time> currentInterval) {//组团未过期
                if (data.pay_status=='1') {//组团中
                  data.typeText = '待成团'
                }else {//未支付
                  //固定制服时间为120分钟  超出后不能支付
                  if (create_time+7200<currentInterval) {//超出支付时间
                    data.typeText = '(未支付)已过期'
                  }else {
                    data.typeText = '待付款'
                  }
                }
              }else {//组团已过期
                data.typeText = '(团购结束)已过期'
              }
            }
          }
          data.typeText='已完成' //测试 变更团购状态
          switch (data.typeText){
            case '已完成'://
              console.log('已完成')
              wepy.setNavigationBarTitle({
                title: '蹭团成功'
              })
              self.groupTitle = '恭喜您,蹭团成功!'
              break;
            case '已取消'://
              console.log('已取消')

              data.color = '#3f2021'
              break;
            case '待发货'://
              console.log('待发货')

              break;
            case '待收货'://
              console.log('待收货')

              break;
            case '待成团'://
              console.log('待成团')

              break;
            case '(未支付)已过期'://
              console.log('(未支付)已过期')

              break;
            case '待付款'://
              console.log('待付款')

              break;
            case '(团购结束)已过期'://
              console.log('(团购结束)已过期')

              break;

            default:
              break;
          }

          self.orderDetail = data
          // console.log(self.orderDetail.typeText)
          console.log(self.orderDetail)
          self.$apply()
        }
      })
    }
    onLoad(options) {
      //蹭团成功  开团成功   团购成功   团购失败
      this.groupState = '团购失败'
      this.order_id = options.order_id
      this.getOrderDetail()

    }
  }
</script>
